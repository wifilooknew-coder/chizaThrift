<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Chiza Thrift</title>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #ffe6f2 url('https://www.transparenttextures.com/patterns/sakura.png');
      background-size: cover;
    }
    h1 {
      color: #d63384;
      text-align: center;
    }
    h2 {
      margin-top: 40px;
      color: #b30e68;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th {
      background: #ff99cc;
      color: white;
      padding: 10px;
    }
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #ff66b2;
      color: white;
    }
    button:hover {
      background: #e0559c;
    }
    .delete-btn {
      background: red;
    }
    p b {
      color: #b30e68;
    }
    input[type="number"], input.harga, input.jumlah {
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>ðŸŒ¸ Chiza Thrift ðŸŒ¸</h1>

  <h2>ðŸ“¦ Penjualan</h2>
  <table id="penjualanTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Produk</th>
        <th>Nama Pembeli</th>
        <th>Harga</th>
        <th>Pembayaran</th>
        <th>Penjual</th>
        <th>Ekspedisi</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow('penjualan')">+ Tambah Penjualan</button>
  <p><b>Total Pesanan (Lunas): Rp <span id="totalPesanan">0</span></b></p>

  <h2>ðŸ’¸ Pengeluaran</h2>
  <table id="pengeluaranTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Keterangan</th>
        <th>Jumlah</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow('pengeluaran')">+ Tambah Pengeluaran</button>
  <p><b>Total Pengeluaran: Rp <span id="totalPengeluaran">0</span></b></p>

  <h2>ðŸ“Š Ringkasan</h2>
  <p><b>Total Bersih: Rp <span id="totalBersih">0</span></b></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbCuzBbqp6uS_B36UEZqZRkw4cZA3GI1Q",
      authDomain: "chizathrift.firebaseapp.com",
      projectId: "chizathrift",
      storageBucket: "chizathrift.appspot.com",
      messagingSenderId: "45254081746",
      appId: "1:45254081746:web:5a51d8a4690d93d513810b",
      databaseURL: "https://chizathrift-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const pembayaranOpts = ["Cash", "Transfer", "Hutang"];
    const penjualOpts = ["Cici", "Azanatun"];
    const ekspedisiOpts = ["JNE", "JNT", "Shopee", "Daily Food Seblak", "Rumah Cici", "Rumah Azanatun"];
    const statusOpts = ["Lunas", "Belum Lunas"];

    // helper format angka
    function formatNumber(num) {
      return Number(num || 0).toLocaleString("id-ID");
    }
    function parseNumber(str) {
      return Number((str || "0").toString().replace(/\./g, ""));
    }

    function addRow(type) {
      const tbody = document.querySelector(`#${type}Table tbody`);
      const newRow = document.createElement("tr");

      if (type === "penjualan") {
        newRow.innerHTML = `
          <td><input type="date"></td>
          <td><input type="text" placeholder="Produk"></td>
          <td><input type="text" placeholder="Nama Pembeli"></td>
          <td><input type="text" class="harga" placeholder="Harga"></td>
          <td>${createSelect(pembayaranOpts)}</td>
          <td>${createSelect(penjualOpts)}</td>
          <td>${createSelect(ekspedisiOpts)}</td>
          <td>${createSelect(statusOpts)}</td>
          <td><button class="delete-btn">Hapus</button></td>
        `;
      } else {
        newRow.innerHTML = `
          <td><input type="date"></td>
          <td><input type="text" placeholder="Keterangan"></td>
          <td><input type="text" class="jumlah" placeholder="Jumlah"></td>
          <td><button class="delete-btn">Hapus</button></td>
        `;
      }

      tbody.appendChild(newRow);

      newRow.querySelector(".delete-btn").addEventListener("click", () => {
        newRow.remove();
        saveData();
      });

      newRow.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("change", e => {
          if (el.classList.contains("harga") || el.classList.contains("jumlah")) {
            el.value = formatNumber(parseNumber(el.value));
          }
          saveData();
        });
      });
    }

    function createSelect(options) {
      return `<select>${options.map(opt => `<option value="${opt}">${opt}</option>`).join("")}</select>`;
    }

    function saveData() {
      const penjualanData = [];
      document.querySelectorAll("#penjualanTable tbody tr").forEach(row => {
        const inputs = row.querySelectorAll("input, select");
        if (inputs.length) {
          penjualanData.push({
            tanggal: inputs[0].value,
            produk: inputs[1].value,
            pembeli: inputs[2].value,
            harga: parseNumber(inputs[3].value),
            pembayaran: inputs[4].value,
            penjual: inputs[5].value,
            ekspedisi: inputs[6].value,
            status: inputs[7].value
          });
        }
      });

      const pengeluaranData = [];
      document.querySelectorAll("#pengeluaranTable tbody tr").forEach(row => {
        const inputs = row.querySelectorAll("input, select");
        if (inputs.length) {
          pengeluaranData.push({
            tanggal: inputs[0].value,
            keterangan: inputs[1].value,
            jumlah: parseNumber(inputs[2].value)
          });
        }
      });

      set(ref(db, "penjualan"), penjualanData);
      set(ref(db, "pengeluaran"), pengeluaranData);
    }

    function loadData() {
      onValue(ref(db, "penjualan"), snapshot => {
        const data = snapshot.val() || [];
        const tbody = document.querySelector("#penjualanTable tbody");
        tbody.innerHTML = "";
        data.forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="date" value="${item.tanggal || ""}"></td>
            <td><input type="text" value="${item.produk || ""}"></td>
            <td><input type="text" value="${item.pembeli || ""}"></td>
            <td><input type="text" class="harga" value="${formatNumber(item.harga) || ""}"></td>
            <td>${createSelect(pembayaranOpts)}</td>
            <td>${createSelect(penjualOpts)}</td>
            <td>${createSelect(ekspedisiOpts)}</td>
            <td>${createSelect(statusOpts)}</td>
            <td><button class="delete-btn">Hapus</button></td>
          `;
          tbody.appendChild(row);

          row.querySelectorAll("select")[0].value = item.pembayaran;
          row.querySelectorAll("select")[1].value = item.penjual;
          row.querySelectorAll("select")[2].value = item.ekspedisi;
          row.querySelectorAll("select")[3].value = item.status;

          row.querySelector(".delete-btn").addEventListener("click", () => {
            row.remove();
            saveData();
          });
          row.querySelectorAll("input, select").forEach(el => {
            el.addEventListener("change", () => {
              if (el.classList.contains("harga")) {
                el.value = formatNumber(parseNumber(el.value));
              }
              saveData();
            });
          });
        });
        updateTotals();
      });

      onValue(ref(db, "pengeluaran"), snapshot => {
        const data = snapshot.val() || [];
        const tbody = document.querySelector("#pengeluaranTable tbody");
        tbody.innerHTML = "";
        data.forEach(item => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td><input type="date" value="${item.tanggal || ""}"></td>
            <td><input type="text" value="${item.keterangan || ""}"></td>
            <td><input type="text" class="jumlah" value="${formatNumber(item.jumlah) || ""}"></td>
            <td><button class="delete-btn">Hapus</button></td>
          `;
          tbody.appendChild(row);

          row.querySelector(".delete-btn").addEventListener("click", () => {
            row.remove();
            saveData();
          });
          row.querySelectorAll("input").forEach(el => {
            el.addEventListener("change", () => {
              if (el.classList.contains("jumlah")) {
                el.value = formatNumber(parseNumber(el.value));
              }
              saveData();
            });
          });
        });
        updateTotals();
      });
    }

    function updateTotals() {
      let totalPesanan = 0;
      document.querySelectorAll("#penjualanTable tbody tr").forEach(row => {
        const harga = parseNumber(row.querySelector(".harga")?.value);
        const status = row.querySelectorAll("select")[3]?.value;
        if (status === "Lunas") {
          totalPesanan += harga;
        }
      });

      let totalPengeluaran = 0;
      document.querySelectorAll("#pengeluaranTable tbody tr").forEach(row => {
        totalPengeluaran += parseNumber(row.querySelector(".jumlah")?.value);
      });

      document.getElementById("totalPesanan").textContent = formatNumber(totalPesanan);
      document.getElementById("totalPengeluaran").textContent = formatNumber(totalPengeluaran);
      document.getElementById("totalBersih").textContent = formatNumber(totalPesanan - totalPengeluaran);
    }

    // âœ… fix tombol addRow biar global
    window.addRow = addRow;

    loadData();
  </script>
</body>
</html>
