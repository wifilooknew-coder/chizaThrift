<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Chiza Thrift</title>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #ffe6f2 url('https://www.transparenttextures.com/patterns/sakura.png');
      background-size: cover;
    }
    h1 {
      color: #d63384;
      text-align: center;
    }
    h2 {
      margin-top: 40px;
      color: #b30e68;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    th {
      background: #ff99cc;
      color: white;
      padding: 10px;
    }
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #ff66b2;
      color: white;
    }
    button:hover {
      background: #e0559c;
    }
    .delete-btn {
      background: red;
    }
    p b {
      color: #b30e68;
    }
  </style>
</head>
<body>
  <h1>ðŸŒ¸ Chiza Thrift ðŸŒ¸</h1>

  <h2>ðŸ“¦ Penjualan</h2>
  <table id="penjualanTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Nama Pembeli</th>
        <th>Harga</th>
        <th>Pembayaran</th>
        <th>Penjual</th>
        <th>Ekspedisi</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow('penjualan')">+ Tambah Penjualan</button>
  <p><b>Total Pesanan (Lunas): Rp <span id="totalPesanan">0</span></b></p>

  <h2>ðŸ’¸ Pengeluaran</h2>
  <table id="pengeluaranTable">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Keterangan</th>
        <th>Jumlah</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow('pengeluaran')">+ Tambah Pengeluaran</button>
  <p><b>Total Pengeluaran: Rp <span id="totalPengeluaran">0</span></b></p>

  <h2>ðŸ“Š Ringkasan</h2>
  <label for="bulanPilihan">Pilih Bulan:</label>
  <select id="bulanPilihan">
    <option value="0">Januari</option>
    <option value="1">Februari</option>
    <option value="2">Maret</option>
    <option value="3">April</option>
    <option value="4">Mei</option>
    <option value="5">Juni</option>
    <option value="6">Juli</option>
    <option value="7">Agustus</option>
    <option value="8">September</option>
    <option value="9">Oktober</option>
    <option value="10">November</option>
    <option value="11">Desember</option>
  </select>
  <select id="tahunPilihan"></select>
  <button onclick="showMonthlySummary()">Lihat</button>

  <p><b>Total Bersih: Rp <span id="totalBersih">0</span></b></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbCuzBbqp6uS_B36UEZqZRkw4cZA3GI1Q",
      authDomain: "chizathrift.firebaseapp.com",
      projectId: "chizathrift",
      storageBucket: "chizathrift.appspot.com",
      messagingSenderId: "45254081746",
      appId: "1:45254081746:web:5a51d8a4690d93d513810b",
      databaseURL: "https://chizathrift-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const pembayaranOpts = ["Cash", "Transfer", "Hutang", "COD"];
    const penjualOpts = ["Cici", "Azanatun"];
    const ekspedisiOpts = ["JNE", "JNT", "Shopee", "Daily Food Seblak", "Rumah Cici", "Rumah Azanatun", "COD SHOPPE"];
    const statusOpts = ["Lunas", "Belum Lunas"];

    function formatInputRupiah(input) {
      input.addEventListener("input", () => {
        let value = input.value.replace(/\./g, "");
        if (value === "") return;
        input.value = Number(value).toLocaleString("id-ID");
      });
    }
    function getNumericValue(input) {
      return Number(input.value.replace(/\./g, "")) || 0;
    }

    function addRow(type) {
      const tbody = document.querySelector(`#${type}Table tbody`);
      const newRow = document.createElement("tr");

      if (type === "penjualan") {
        newRow.innerHTML = `
          <td><input type="date"></td>
          <td><input type="text" placeholder="Nama Pembeli"></td>
          <td><input type="text" placeholder="Harga"></td>
          <td>${createSelect(pembayaranOpts)}</td>
          <td>${createSelect(penjualOpts)}</td>
          <td>${createSelect(ekspedisiOpts)}</td>
          <td>${createSelect(statusOpts)}</td>
          <td><button class="delete-btn">Hapus</button></td>
        `;
        formatInputRupiah(newRow.querySelectorAll("input")[2]);
      } else {
        newRow.innerHTML = `
          <td><input type="date"></td>
          <td><input type="text" placeholder="Keterangan"></td>
          <td><input type="text" placeholder="Jumlah"></td>
          <td><button class="delete-btn">Hapus</button></td>
        `;
        formatInputRupiah(newRow.querySelectorAll("input")[2]);
      }

      tbody.appendChild(newRow);

      newRow.querySelector(".delete-btn").addEventListener("click", () => {
        if (confirm("Apa kamu yakin ingin menghapus data ini?")) {
          newRow.remove();
          saveData();
        }
      });

      newRow.querySelectorAll("input, select").forEach(el => {
        el.addEventListener("change", saveData);
      });
    }

    function createSelect(options) {
      return `<select>${options.map(opt => `<option value="${opt}">${opt}</option>`).join("")}</select>`;
    }

    function saveData() {
      const penjualanData = [];
      document.querySelectorAll("#penjualanTable tbody tr").forEach(row => {
        const inputs = row.querySelectorAll("input, select");
        if (inputs.length) {
          penjualanData.push({
            tanggal: inputs[0].value,
            pembeli: inputs[1].value,
            harga: getNumericValue(inputs[2]),
            pembayaran: inputs[3].value,
            penjual: inputs[4].value,
            ekspedisi: inputs[5].value,
            status: inputs[6].value
          });
        }
      });

      const pengeluaranData = [];
      document.querySelectorAll("#pengeluaranTable tbody tr").forEach(row => {
        const inputs = row.querySelectorAll("input, select");
        if (inputs.length) {
          pengeluaranData.push({
            tanggal: inputs[0].value,
            keterangan: inputs[1].value,
            jumlah: getNumericValue(inputs[2])
          });
        }
      });

      set(ref(db, "penjualan"), penjualanData);
      set(ref(db, "pengeluaran"), pengeluaranData);
      updateTotals(penjualanData, pengeluaranData);
    }

    function updateTotals(penjualanData, pengeluaranData) {
      let totalPesanan = penjualanData.filter(d => d.status === "Lunas").reduce((s, d) => s + d.harga, 0);
      let totalPengeluaran = pengeluaranData.reduce((s, d) => s + d.jumlah, 0);
      let totalBersih = totalPesanan - totalPengeluaran;

      document.getElementById("totalPesanan").textContent = totalPesanan.toLocaleString("id-ID");
      document.getElementById("totalPengeluaran").textContent = totalPengeluaran.toLocaleString("id-ID");
      document.getElementById("totalBersih").textContent = totalBersih.toLocaleString("id-ID");
    }

    onValue(ref(db), snap => {
      const data = snap.val();
      if (data) loadData(data.penjualan || [], data.pengeluaran || []);
    });

    function loadData(penjualanData, pengeluaranData) {
      const tPenjualan = document.querySelector("#penjualanTable tbody");
      const tPengeluaran = document.querySelector("#pengeluaranTable tbody");
      tPenjualan.innerHTML = ""; tPengeluaran.innerHTML = "";

      penjualanData.forEach(d => {
        addRow("penjualan");
        const r = tPenjualan.lastChild.querySelectorAll("input, select");
        r[0].value = d.tanggal || "";
        r[1].value = d.pembeli || "";
        r[2].value = d.harga ? d.harga.toLocaleString("id-ID") : "";
        r[3].value = d.pembayaran || pembayaranOpts[0];
        r[4].value = d.penjual || penjualOpts[0];
        r[5].value = d.ekspedisi || ekspedisiOpts[0];
        r[6].value = d.status || statusOpts[0];
      });

      pengeluaranData.forEach(d => {
        addRow("pengeluaran");
        const r = tPengeluaran.lastChild.querySelectorAll("input, select");
        r[0].value = d.tanggal || "";
        r[1].value = d.keterangan || "";
        r[2].value = d.jumlah ? d.jumlah.toLocaleString("id-ID") : "";
      });

      updateTotals(penjualanData, pengeluaranData);
    }

    // === Ringkasan Bulanan ===
    function populateTahunOptions() {
      const tahunSelect = document.getElementById("tahunPilihan");
      const thisYear = new Date().getFullYear();
      for (let y = thisYear - 5; y <= thisYear + 5; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === thisYear) opt.selected = true;
        tahunSelect.appendChild(opt);
      }
    }
    populateTahunOptions();

    function showMonthlySummary() {
      const bulan = parseInt(document.getElementById("bulanPilihan").value);
      const tahun = parseInt(document.getElementById("tahunPilihan").value);

      const penjualanRows = document.querySelectorAll("#penjualanTable tbody tr");
      const pengeluaranRows = document.querySelectorAll("#pengeluaranTable tbody tr");

      let totalPesanan = 0, totalPengeluaran = 0;

      penjualanRows.forEach(row => {
        const inputs = row.querySelectorAll("input, select");
        const tgl = inputs[0].value;
        const harga = getNumericValue(inputs[2]);
        const status = inputs[6].value;
        if (tgl) {
          const d = new Date(tgl);
          if (d.getMonth() === bulan && d.getFullYear() === tahun && status === "Lunas") {
            totalPesanan += harga;
          }
        }
      });

      pengeluaranRows.forEach(row => {
        const inputs = row.querySelectorAll("input");
        const tgl = inputs[0].value;
        const jumlah = getNumericValue(inputs[2]);
        if (tgl) {
          const d = new Date(tgl);
          if (d.getMonth() === bulan && d.getFullYear() === tahun) {
            totalPengeluaran += jumlah;
          }
        }
      });

      const totalBersih = totalPesanan - totalPengeluaran;
      alert(`ðŸ“Š Ringkasan ${document.getElementById("bulanPilihan").options[bulan].text} ${tahun}\n\nâœ… Total Pesanan: Rp ${totalPesanan.toLocaleString("id-ID")}\nðŸ’¸ Total Pengeluaran: Rp ${totalPengeluaran.toLocaleString("id-ID")}\nðŸ’° Total Bersih: Rp ${totalBersih.toLocaleString("id-ID")}`);
    }

    window.addRow = addRow;
    window.showMonthlySummary = showMonthlySummary;
  </script>
</body>
</html>
